#!/bin/bash

echo "âš ï¸  ATTENTION : cette opÃ©ration va supprimer le cluster Kubernetes local (via kubeadm) !"
read -p "Souhaites-tu vraiment continuer ? [y/N] " confirm

if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo "âŒ OpÃ©ration annulÃ©e."
    exit 1
fi

echo "ğŸ” RÃ©initialisation kubeadm..."
sudo kubeadm reset -f

echo "ğŸ§¹ Suppression des fichiers de configuration Kubernetes..."
sudo rm -rf /etc/kubernetes \
            /etc/cni \
            /var/lib/etcd \
            /var/lib/kubelet \
            /var/lib/cni \
            /opt/cni \
            /etc/systemd/system/kubelet.service.d \
            $HOME/.kube

echo "ğŸ§¼ Suppression des rÃ¨gles iptables CNI..."
sudo iptables -F
sudo iptables -t nat -F
sudo iptables -t mangle -F
sudo iptables -X

echo "ğŸ”„ RedÃ©marrage du dÃ©mon systemd et arrÃªt des services..."
sudo systemctl daemon-reexec
sudo systemctl stop kubelet

if command -v docker &> /dev/null; then
    echo "ğŸ›‘ ArrÃªt et suppression des conteneurs Docker..."
    sudo docker rm -f $(sudo docker ps -aq) 2>/dev/null || true
    sudo systemctl stop docker
fi

if command -v crictl &> /dev/null; then
    echo "ğŸ›‘ ArrÃªt et suppression des conteneurs containerd..."
    sudo crictl rm -f $(sudo crictl ps -q) 2>/dev/null || true
    sudo systemctl stop containerd
fi

echo "âœ… Kubernetes dÃ©sinstallÃ© proprement sur ce nÅ“ud."
